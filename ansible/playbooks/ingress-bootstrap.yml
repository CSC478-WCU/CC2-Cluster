---
- name: Bootstrap ingress + external-dns + metallb
  hosts: kubeadmin
  become: yes
  vars_files:
    - ../vault/cloudflare.yml   # contains cloudflare_api_token

  tasks:
    # -------------------
    # Discover subnet for MetalLB
    # -------------------
    - name: Get primary interface IPv4 CIDR
      ansible.builtin.command: ip -4 addr show dev eno1
      register: ip_addr
      changed_when: false

    - name: Parse CIDR from ip addr output
      ansible.builtin.set_fact:
        node_cidr: "{{ ip_addr.stdout_lines | select('search', 'inet ') | first | regex_search('inet ([0-9.]+/[0-9]+)', '\\1') | first }}"

    - name: Derive subnet base (for pool)
      ansible.builtin.set_fact:
        subnet_base: "{{ node_cidr.split('/')[0].rsplit('.', 1)[0] }}"
        subnet_prefix: "{{ node_cidr.split('/')[1] }}"

    - name: Define MetalLB address pool range
      ansible.builtin.set_fact:
        metallb_range: "{{ subnet_base }}.200-{{ subnet_base }}.220"

    # -------------------
    # MetalLB
    # -------------------
    - name: Install MetalLB manifests
      kubernetes.core.k8s:
        state: present
        kubeconfig: /etc/kubernetes/admin.conf
        src: https://raw.githubusercontent.com/metallb/metallb/v0.14.5/config/manifests/metallb-native.yaml

    - name: Wait for metallb controller rollout
      ansible.builtin.command: >
        kubectl --kubeconfig=/etc/kubernetes/admin.conf
        -n metallb-system rollout status deployment/controller --timeout=180s
      changed_when: false

    - name: Configure MetalLB IPAddressPool (auto-discovered)
      kubernetes.core.k8s:
        state: present
        kubeconfig: /etc/kubernetes/admin.conf
        definition:
          apiVersion: metallb.io/v1beta1
          kind: IPAddressPool
          metadata:
            name: default-pool
            namespace: metallb-system
          spec:
            addresses:
              - "{{ metallb_range }}"

    - name: Configure MetalLB L2Advertisement
      kubernetes.core.k8s:
        state: present
        kubeconfig: /etc/kubernetes/admin.conf
        definition:
          apiVersion: metallb.io/v1beta1
          kind: L2Advertisement
          metadata:
            name: default
            namespace: metallb-system
          spec:
            ipAddressPools:
              - default-pool

    # -------------------
    # Ingress Controller
    # -------------------
    - name: Add ingress-nginx repo
      kubernetes.core.helm_repository:
        name: ingress-nginx
        repo_url: https://kubernetes.github.io/ingress-nginx

    - name: Install/upgrade ingress-nginx
      kubernetes.core.helm:
        name: ingress-nginx
        chart_ref: ingress-nginx/ingress-nginx
        release_namespace: ingress-nginx
        create_namespace: true
        kubeconfig: /etc/kubernetes/admin.conf
        wait: true
        timeout: "600s"
        values:
          controller:
            service:
              type: LoadBalancer
            admissionWebhooks:
              enabled: false

    # -------------------
    # ExternalDNS (Cloudflare)
    # -------------------
    - name: Add bitnami repo
      kubernetes.core.helm_repository:
        name: bitnami
        repo_url: https://charts.bitnami.com/bitnami

    - name: Install/upgrade external-dns
      kubernetes.core.helm:
        name: external-dns
        chart_ref: bitnami/external-dns
        release_namespace: external-dns
        create_namespace: true
        kubeconfig: /etc/kubernetes/admin.conf
        wait: true
        timeout: "600s"
        values:
          sources:
            - ingress
            - service
          provider: cloudflare
          cloudflare:
            apiToken: "{{ cloudflare_api_token }}"
          domainFilters:
            - campusconnectwcu.com
          policy: sync
          txtOwnerId: campusconnect
          interval: 1m
          logLevel: info

    # -------------------
    # Ingress chart from repo
    # -------------------
    - name: Deploy ingress Helm chart
      kubernetes.core.helm:
        name: campusconnect-ingress
        chart_ref: "/users/{{ ansible_user }}/local/repository/helm/ingress"
        release_namespace: default
        create_namespace: false
        kubeconfig: /etc/kubernetes/admin.conf
        wait: true
        timeout: "600s"
