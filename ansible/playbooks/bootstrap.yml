---
- hosts: localhost
  connection: local
  gather_facts: false
  vars:
    nodes: "{{ nodes_json | from_json }}"
    ssh_user: "{{ ssh_user | default('deploy') }}"
  tasks:
    - name: Register CloudLab nodes
      add_host:
        name: "{{ item.key }}"
        ansible_host: "{{ item.value }}"
        ansible_user: "{{ ssh_user }}"
        groups: >-
          {{ 'workers' if item.key != 'kubeadm' else 'kubeadmin' }},
          cloudlab_nodes
      loop: "{{ nodes | dict2items }}"

# ----------------------------
# Phase 1: Base System
# ----------------------------
- hosts: cloudlab_nodes
  become: yes
  roles:
    - base
    - containerd
    - kube-tools
    - helm

- hosts: kubeadmin
  become: yes
  roles:
    - python-k8s

# ----------------------------
# Phase 2: Cluster Init
# ----------------------------
- hosts: kubeadmin
  become: yes
  roles:
    - kubeadm-init
    - cni-flannel

- hosts: workers
  become: yes
  roles:
    - kubeadm-join

# ----------------------------
# Phase 3: Networking + Ingress
# ----------------------------
- hosts: kubeadmin
  become: yes
  vars_files: 
    - ../vault/cloudflare.yml
  roles:
    - metallb
    - ingress-nginx
    - external-dns
    - ingress-app
    - ceph
    - metrics
