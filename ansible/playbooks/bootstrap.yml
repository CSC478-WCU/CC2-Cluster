---
- hosts: localhost
  gather_facts: false
  vars:
    nodes: "{{ nodes_json | from_json }}"   # {"kubeadm":"155.98.38.240","worker1":"155.98.36.94","worker2":"155.98.36.95"}
    ssh_user: "{{ ssh_user | default('deploy') }}"
  tasks:
    - name: Register each node in inventory
      add_host:
        name: "{{ item.key }}"                 # kubeadm / worker1 / worker2
        ansible_host: "{{ item.value }}"       # IP address
        ansible_user: "{{ ssh_user }}"         # SSH user
        groups: "{{ 'workers' if item.key != 'kubeadm' else 'kubeadmin' }}"
      loop: "{{ nodes | dict2items }}"

# hand off to the cluster setup plays
- import_playbook: install_deps.yml
- import_playbook: kubeadm_cluster.yml
