---
# roles/external-dns/tasks/main.yml
# ---------------------------------
# Install ExternalDNS with Cloudflare provider.

- name: Add bitnami repo
  kubernetes.core.helm_repository:
    name: bitnami
    repo_url: https://charts.bitnami.com/bitnami

- name: Deploy external-dns
  kubernetes.core.helm:
    name: external-dns
    chart_ref: bitnami/external-dns
    release_namespace: external-dns
    create_namespace: true
    kubeconfig: /etc/kubernetes/admin.conf
    wait: true
    timeout: "600s"
    values:
      sources:
        - ingress
        - service
      provider: cloudflare
      cloudflare:
        apiToken: "{{ cloudflare_api_token }}"
      domainFilters:
        - campusconnectwcu.com
      policy: sync
      txtOwnerId: campusconnect
      interval: 1m
      logLevel: info
